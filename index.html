<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çš®å…‹æ•æ–·é£Ÿ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/189/189664.png">
    <meta name="theme-color" content="#E8F6F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #E8F6F3; --card: #FFF; --red: #E74C3C; --yellow: #F1C40F; --blue: #3498DB; --green: #2ECC71; --text: #2C3E50; }
        body { font-family: 'Varela Round', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        .container { background: var(--card); width: 100%; max-width: 380px; border-radius: 30px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin-top: 20px;}
        h1 { margin: 0 0 10px; color: var(--text); }
        
        /* è¦–è¦ºå€ */
        .visual-circle { width: 180px; height: 180px; background: #F4F6F7; border-radius: 50%; margin: 10px auto; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 6px solid var(--green); transition: border-color 0.5s; position: relative;}
        .emoji { font-size: 5rem; animation: bounce 3s infinite ease-in-out; }
        .status { font-weight: bold; margin-top: 10px; color: var(--green); }
        .timer { font-size: 3.5rem; font-weight: 700; margin: 5px 0 15px; font-variant-numeric: tabular-nums; line-height: 1; }
        
        /* æ™‚é–“é¸æ“‡å™¨æ¨£å¼ */
        .time-input-group { background: #F8F9F9; padding: 10px; border-radius: 15px; margin-bottom: 15px; text-align: left; }
        .time-label { font-size: 0.8rem; color: #7F8C8D; margin-bottom: 5px; display: block; }
        input[type="datetime-local"] {
            width: 100%; padding: 10px; font-size: 1.1rem; border: 1px solid #BDC3C7; border-radius: 10px; 
            font-family: sans-serif; box-sizing: border-box; background: white; -webkit-appearance: none;
        }

        /* æŒ‰éˆ•å€ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { border: none; padding: 15px; border-radius: 15px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
        button:active { transform: scale(0.96); }
        .btn-fast { background: var(--blue); } .btn-eat { background: var(--red); }
        .btn-disabled { opacity: 0.5; pointer-events: none; background: #BDC3C7; box-shadow: none; }
        
        @keyframes bounce { 0%,100% {transform:rotate(-5deg)} 50% {transform:rotate(5deg) translateY(-5px)} }
        #history { margin-top: 30px; width: 100%; max-width: 380px; text-align: left; font-size: 0.9rem; color: #7F8C8D; }
        .hist-item { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pikmin 168</h1>
        
        <div class="visual-circle" id="circle">
            <div class="emoji" id="icon">ğŸŒ±</div>
            <div class="status" id="status">æº–å‚™ä¸­</div>
        </div>
        
        <div class="timer" id="timer">00:00:00</div>
        
        <div class="time-input-group">
            <label class="time-label">ğŸ“… è¨­å®šæ“ä½œæ™‚é–“ (é è¨­ç‚ºç¾åœ¨)</label>
            <input type="datetime-local" id="picker">
            <div style="text-align:right; margin-top:5px;">
                <span onclick="setPickerNow()" style="font-size:0.8rem; color:var(--blue); text-decoration:underline; cursor:pointer;">é‡ç½®ç‚ºç¾åœ¨</span>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-fast" id="btnFast" onclick="handleAction(true)">ğŸŒ™ é–‹å§‹æ–·é£Ÿ</button>
            <button class="btn-eat btn-disabled" id="btnEat" onclick="handleAction(false)">ğŸ³ çµæŸæ–·é£Ÿ</button>
        </div>
    </div>

    <div id="history">
        <b>è¿‘æœŸç´€éŒ„ (æœ¬åœ°ç«¯)ï¼š</b>
        <div id="histList"></div>
    </div>

    <script>
        // PWA è¨»å†Š
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

        // è®Šæ•¸
        let start = localStorage.getItem('p_start');
        let fasting = localStorage.getItem('p_fast') === 'true';
        let history = JSON.parse(localStorage.getItem('p_history') || '[]');
        let timerInt;

        window.onload = () => {
            setPickerNow(); // åˆå§‹åŒ–æ™‚é–“é¸æ“‡å™¨ç‚ºç¾åœ¨
            renderHistory();
            if(fasting && start) { start = new Date(start); loop(); }
            updateUI();
        };

        // è¨­å®šæ™‚é–“é¸æ“‡å™¨ç‚ºç¾åœ¨æ™‚é–“ (è™•ç†æ™‚å€å•é¡Œ)
        function setPickerNow() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('picker').value = now.toISOString().slice(0,16);
        }

        // æ ¸å¿ƒé‚è¼¯ï¼šè™•ç†æŒ‰éˆ•é»æ“Š
        function handleAction(isStart) {
            const pickerTime = new Date(document.getElementById('picker').value);
            
            if(isStart) {
                // é–‹å§‹æ–·é£Ÿ (è£œç™»)
                if(fasting) return;
                start = pickerTime;
                fasting = true;
                
                localStorage.setItem('p_start', start);
                localStorage.setItem('p_fast', 'true');
                loop();
                alert(`è¨­å®šå¾ ${pickerTime.toLocaleString()} é–‹å§‹æ–·é£Ÿï¼`);
            } else {
                // çµæŸæ–·é£Ÿ (è£œç™»)
                if(!fasting) return;
                
                if(pickerTime < start) {
                    alert("çµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼é–‹å§‹æ™‚é–“å–”ï¼");
                    return;
                }

                // è¨ˆç®—æ™‚é•· (ä½¿ç”¨é¸æ“‡å™¨çš„æ™‚é–“ - é–‹å§‹æ™‚é–“)
                let diff = pickerTime - start;
                let hrs = (diff / 3600000).toFixed(1);
                
                // å„²å­˜ç´€éŒ„
                addHistory(pickerTime, hrs);

                fasting = false;
                localStorage.setItem('p_fast', 'false');
                clearInterval(timerInt);
                alert(`æ–·é£ŸçµæŸï¼å…± ${hrs} å°æ™‚`);
            }
            updateUI();
            setPickerNow(); // æ“ä½œå®Œå¾Œï¼ŒæŠŠæ™‚é–“é‡ç½®å›ç¾åœ¨
        }

        function loop() { clearInterval(timerInt); timerInt = setInterval(updateTimer, 1000); updateTimer(); }
        
        function updateTimer() {
            // è¨ˆæ™‚å™¨æ°¸é é¡¯ç¤ºã€Œç¾åœ¨ - é–‹å§‹æ™‚é–“ã€
            let diff = new Date() - start;
            // å¦‚æœæ˜¯è£œç™»æœªä¾†æ™‚é–“ï¼Œé¿å…è² æ•¸
            if(diff < 0) diff = 0; 

            let h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            document.getElementById('timer').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
            
            // çš®å…‹æ•é€²åŒ–
            let icon = document.getElementById('icon');
            let circle = document.getElementById('circle');
            let st = document.getElementById('status');
            
            if(h < 12) { icon.innerText="ğŸŒ±"; circle.style.borderColor="var(--green)"; st.style.color="var(--green)"; st.innerText="ç‡ƒç‡’è‚é†£"; }
            else if(h < 16) { icon.innerText="ğŸŒ·"; circle.style.borderColor="var(--yellow)"; st.style.color="var(--yellow)"; st.innerText="ç‡ƒè„‚æ¨¡å¼"; }
            else { icon.innerText="ğŸŒº"; circle.style.borderColor="var(--red)"; st.style.color="var(--red)"; st.innerText="168 é”æ¨™"; }
        }

        function updateUI() {
            document.getElementById('btnFast').className = fasting ? 'btn-fast btn-disabled' : 'btn-fast';
            document.getElementById('btnEat').className = fasting ? 'btn-eat' : 'btn-eat btn-disabled';
            if(!fasting) {
                 document.getElementById('icon').innerText="ğŸ’"; 
                 document.getElementById('status').innerText="é€²é£Ÿçª—å£";
                 document.getElementById('status').style.color="var(--blue)";
                 document.getElementById('circle').style.borderColor="var(--blue)";
                 document.getElementById('timer').innerText="00:00:00";
            }
        }

        function addHistory(endDate, hrs) {
            let rec = { date: endDate.toLocaleDateString(), hrs: hrs };
            history.unshift(rec);
            if(history.length > 5) history.pop(); // åªç•™æœ€è¿‘5ç­†
            localStorage.setItem('p_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            let html = '';
            history.forEach(r => {
                let color = r.hrs >= 16 ? 'var(--red)' : '#7F8C8D';
                html += `<div class="hist-item"><span>${r.date}</span><span style="color:${color}; font-weight:bold;">${r.hrs} h</span></div>`;
            });
            document.getElementById('histList').innerHTML = html || 'å°šç„¡ç´€éŒ„';
        }

        function pad(n){return n<10?'0'+n:n}
    </script>
</body>
</html>
